services:
  db:
    image: postgres:16
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - db_data:/var/lib/postgresql/data

  mcp_server:
    build: ./server
    restart: unless-stopped
    environment:
      DB_URL_ADMIN: ${DB_URL_ADMIN}
      DB_URL_RO: ${DB_URL_RO}
      MCP_TRANSPORT: ${MCP_TRANSPORT:-sse}
      MCP_HOST: 0.0.0.0
      MCP_PORT: ${MCP_PORT:-8765}
    depends_on:
      - db
    tty: true
    ports:
      - "${MCP_PORT:-8765}:${MCP_PORT:-8765}"

  chat_gateway:
    build:
      context: .
      dockerfile: app/Dockerfile
    restart: unless-stopped
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4.1-mini}
      LLM_PROVIDER: ${LLM_PROVIDER:-openai}
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434/v1}
      OLLAMA_MODEL: ${OLLAMA_MODEL:-qwen3-coder:30b}
      OLLAMA_API_KEY: ${OLLAMA_API_KEY:-ollama}
      MCP_SSE_URL: ${MCP_SSE_URL:-http://mcp_server:${MCP_PORT:-8765}/sse}
      DB_URL_ADMIN: ${DB_URL_ADMIN}
      DB_URL_RO: ${DB_URL_RO}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    depends_on:
      - db
    ports:
      - "8000:8000"

volumes:
  db_data:
